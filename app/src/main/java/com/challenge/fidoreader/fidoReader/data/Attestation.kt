package com.challenge.fidoreader.fidoReader.data

import com.challenge.fidoreader.Util.hexStringToByteArray
import com.challenge.fidoreader.fidoReader.data.Attestation.Companion.U2F_RAW_BATCH_ATTESTATION_KEY
import java.security.KeyFactory
import java.security.Signature
import java.security.spec.PKCS8EncodedKeySpec

class Attestation {
    var FULL_ATTESTATION_CERT: ByteArray
    var FULL_ATTESTATION_CA_CERT: ByteArray
    var U2F_RAW_BATCH_ATTESTATION_CERT: ByteArray

    companion object {
        // A777BFFBDDCD6325382448C2320D68D9E4E556A38A508ED783C7A1E4BACFF14E
        val FULL_ATTESTATION_PRIVATE_KEY = byteArrayOf(
                0xA7.toByte(), 0x77.toByte(), 0xBF.toByte(), 0xFB.toByte(), 0xDD.toByte(), 0xCD.toByte(),
                0x63.toByte(), 0x25.toByte(), 0x38.toByte(), 0x24.toByte(), 0x48.toByte(), 0xC2.toByte(),
                0x32.toByte(), 0x0D.toByte(), 0x68.toByte(), 0xD9.toByte(), 0xE4.toByte(), 0xE5.toByte(),
                0x56.toByte(), 0xA3.toByte(), 0x8A.toByte(), 0x50.toByte(), 0x8E.toByte(), 0xD7.toByte(),
                0x83.toByte(), 0xC7.toByte(), 0xA1.toByte(), 0xE4.toByte(), 0xBA.toByte(), 0xCF.toByte(),
                0xF1.toByte(), 0x4E.toByte()
        )

        val U2F_RAW_BATCH_ATTESTATION_KEY = ubyteArrayOf(
                0xC0u, 0xEEu, 0xE9u, 0xCAu, 0x76u, 0xD5u, 0xB2u, 0x88u, 0xE2u, 0x9Du, 0xE7u, 0x35u, 0x0Cu,
                0x75u, 0xD2u, 0x32u, 0xA7u, 0x35u, 0x24u, 0x49u, 0xB1u, 0xA4u, 0x77u, 0xB7u, 0x32u, 0x2Cu,
                0xA5u, 0x2Cu, 0x4Au, 0x00u, 0xBAu, 0x68u
        ).toByteArray()

        const val STRING_FULL_ATTESTATION_CERT = "3082022F308201D4A003020102020101300C06082A8648CE3D04030205003079310B3009060355040613024B52310D300B060355040A13044B6F6E6131223020060355040B131941757468656E74696361746F72204174746573746174696F6E313730350603550403132E4649444F322E302041757468656E74696361746F7220496E7465726D656469617465204365727469666963617465301E170D3031303130313030303030305A170D3330313233313233353935395A3077310B3009060355040613024B52310D300B060355040A13044B6F6E6131223020060355040B131941757468656E74696361746F72204174746573746174696F6E313530330603550403132C4649444F322E302041757468656E74696361746F7220456E6420456E746974792043657274696669636174653059301306072A8648CE3D020106082A8648CE3D030107034200048C0CF9F21067659DCFB3DE26798D93AC7F83AF307084949CB3CAEA4F32E06A6B128FAA7368E5BB432DF43BFBF19883CE741D0E24025CD236E156B8F62009CF81A34D304B30090603551D1304023000301D0603551D0E041604143A4BD917720FA186BF57992BF18BF71521831413301F0603551D230418301680149A2576C61525A126DC7F7216BA7E2F53DD780781300C06082A8648CE3D0403020500034700304402200849439AEED7336D0451ED2E6FE7AD293A5F82C3AC9A8A3A599B59C77AFE149102207B0A6AC132E46E385123081587AC26AF8836E56ABE3DC8F4973680992B28AD62"
        const val STRING_FULL_ATTESTATION_CA_CERT = "3082022D308201D1A003020102020101300C06082A8648CE3D04030205003071310B3009060355040613024B52310D300B060355040A13044B6F6E6131223020060355040B131941757468656E74696361746F72204174746573746174696F6E312F302D060355040313264649444F322E302041757468656E74696361746F7220526F6F74204365727469666963617465301E170D3031303130313030303030305A170D3330313233313233353935395A3079310B3009060355040613024B52310D300B060355040A13044B6F6E6131223020060355040B131941757468656E74696361746F72204174746573746174696F6E313730350603550403132E4649444F322E302041757468656E74696361746F7220496E7465726D6564696174652043657274696669636174653059301306072A8648CE3D020106082A8648CE3D030107034200048B19473833CF39DB9DE0A6DC50F6EC6C17FCE9DAF18A027B8D4AA1614D293C05E281E0B5B828392C2AC9745F5AF69BBAA94D34E6E52754AAC1670D6F2F2FBD7DA350304E300C0603551D13040530030101FF301D0603551D0E041604149A2576C61525A126DC7F7216BA7E2F53DD780781301F0603551D23041830168014DEE22D8D4300E768716952A7D8E6AFF7E51CFD72300C06082A8648CE3D04030205000348003045022073128DEC1787CDE93435467FD6227C122C992F029B83C1BB5B98E8A8A1873511022100F1B1A9E56DB33AAE2779013CD8503EAEEB16D92FA9D88C643CBA98770108D58D"
        const val STRING_U2F_RAW_BATCH_ATTESTATION_CERT = "308201F9308201A0A003020102020109300A06082A8648CE3D0403023040310B3009060355040613024B52310D300B060355040A13044B6F6E613110300E060355040B1307507269766174653110300E060355040313074B6F6E61454343301E170D3136303531393034343130305A170D3137303531393034343130305A3044310B3009060355040613024B52310D300B060355040A13044B6F6E6131123010060355040B13095072697661746543413112301006035504030C094649444F5F5369676E3059301306072A8648CE3D020106082A8648CE3D030107034200042477D49300E71EE0DD4B868A62897DF501D27F0F87958923EF348F246B0AFC5471C72FBF769F97747558A4C2951B95D9ED5944926303D19F196B20902E108D44A38186308183301D0603551D0E04160414A7C65AC944E8D5146F5CBEB5FC328931908A535230520603551D23044B3049A144A4423040310B3009060355040613024B52310D300B060355040A13044B6F6E613110300E060355040B1307507269766174653110300E060355040313074B6F6E61454343820101300E0603551D0F0101FF0404030205E0300A06082A8648CE3D0403020347003044022011C9C9C29DA2A4933D7870144DB604B3E1B55FD0E4CBAD31EC9F1D039CCF0BA6022047D3A2509478D8647E4EA51B01BD9B6E99835685A8D9A2E0D1D8EBE811132AEA"
    }

    init {
        FULL_ATTESTATION_CERT = STRING_FULL_ATTESTATION_CERT.hexStringToByteArray()
        FULL_ATTESTATION_CA_CERT = STRING_FULL_ATTESTATION_CA_CERT.hexStringToByteArray()
        U2F_RAW_BATCH_ATTESTATION_CERT = STRING_U2F_RAW_BATCH_ATTESTATION_CERT.hexStringToByteArray()
    }
}

@ExperimentalUnsignedTypes
private val U2F_BATCH_ATTESTATION_KEY by lazy {
    KeyFactory.getInstance("EC").generatePrivate(
            PKCS8EncodedKeySpec(U2F_RAW_BATCH_ATTESTATION_KEY))
}

@ExperimentalUnsignedTypes
fun signWithU2fBatchAttestationKey(vararg data: ByteArray): ByteArray {
    val sign = Signature.getInstance("SHA256withECDSA")
    sign.initSign(U2F_BATCH_ATTESTATION_KEY)
    for (datum in data) {
        sign.update(datum)
    }
    return sign.sign()
}
